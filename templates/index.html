{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="container">
    {% if error %}
    <div class="alert alert-error">
        <strong>Validation Failed:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="hero-simple">
        <h1>IPO Validation System</h1>
        <p class="hero-subtitle">Automated validation of Epicor's PartUsage data against IP&O</p>
    </div>

    {% if scheduler_info.enabled %}
    <div class="card countdown-card">
        <h3>Next Scheduled Validation</h3>
        <div class="countdown-display" id="countdown-display">
            <div class="countdown-unit">
                <div class="countdown-value" id="days">--</div>
                <div class="countdown-label">Days</div>
            </div>
            <div class="countdown-separator">:</div>
            <div class="countdown-unit">
                <div class="countdown-value" id="hours">--</div>
                <div class="countdown-label">Hours</div>
            </div>
            <div class="countdown-separator">:</div>
            <div class="countdown-unit">
                <div class="countdown-value" id="minutes">--</div>
                <div class="countdown-label">Minutes</div>
            </div>
            <div class="countdown-separator">:</div>
            <div class="countdown-unit">
                <div class="countdown-value" id="seconds">--</div>
                <div class="countdown-label">Seconds</div>
            </div>
        </div>
        <p class="countdown-time">Scheduled for: <span id="scheduled-time">{{ scheduler_info.next_run_time }}</span></p>
        
        <div class="countdown-divider">
            <span>or</span>
        </div>
        
        <div class="manual-validation-section">
            <h4>Run Validation Now</h4>
            <p class="manual-description">Don't want to wait? Trigger a validation immediately.</p>
            <form method="POST" action="{{ url_for('start_validation') }}" style="display: inline-block;">
                <button type="submit" class="btn btn-large">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Start Manual Validation</span>
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // Next run time from server (ISO format)
        const nextRunTime = new Date('{{ scheduler_info.next_run_time }}');
        
        function updateCountdown() {
            const now = new Date();
            const diff = nextRunTime - now;
            
            if (diff <= 0) {
                // Countdown expired, reload page
                location.reload();
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('days').textContent = String(days).padStart(2, '0');
            document.getElementById('hours').textContent = String(hours).padStart(2, '0');
            document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
            document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
            
            // Format the scheduled time nicely
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                timeZoneName: 'short'
            };
            document.getElementById('scheduled-time').textContent = nextRunTime.toLocaleString('en-US', options);
        }
        
        // Update immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
    </script>
    {% else %}
    <div class="card countdown-card">
        <h3>Automatic Scheduling</h3>
        <p class="scheduler-disabled-text">Scheduler is currently disabled. Enable it in <code>config.json</code> to automatically run validations on a schedule.</p>
        
        <div class="countdown-divider">
            <span>Run Validation Manually</span>
        </div>
        
        <div class="manual-validation-section">
            <p class="manual-description">Start a validation check immediately to compare PartUsage data against IPO forecasts.</p>
            <form method="POST" action="{{ url_for('start_validation') }}" style="display: inline-block;">
                <button type="submit" class="btn btn-large">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Start Validation Check</span>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="action-center">
        <a href="{{ url_for('validations_dashboard') }}" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            <span>View Validation History</span>
        </a>
    </div>
</div>
{% endblock %}

